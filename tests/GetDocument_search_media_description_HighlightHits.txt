# New mapping with the nested media.utterances field as media.utterances.utterances
# Test queries for inner_hits in both media.description and media.utterances.utterances
# Full api/es get socken query
GET isof-publik_20250509-metadata/_search
{
  "aggs": {
    "data": {
      "aggs": {
        "data": {
          "aggs": {
            "data": {
              "terms": {
                "field": "places.name",
                "order": {
                  "_key": "asc"
                },
                "size": 1
              }
            },
            "harad": {
              "terms": {
                "field": "places.harad",
                "order": {
                  "_key": "asc"
                },
                "size": 1
              }
            },
            "lan": {
              "terms": {
                "field": "places.county",
                "order": {
                  "_key": "asc"
                },
                "size": 1
              }
            },
            "landskap": {
              "terms": {
                "field": "places.landskap",
                "order": {
                  "_key": "asc"
                },
                "size": 1
              }
            },
            "lm_id": {
              "terms": {
                "field": "places.lm_id",
                "order": {
                  "_key": "asc"
                },
                "size": 1
              }
            },
            "location": {
              "geohash_grid": {
                "field": "places.location",
                "precision": 12
              }
            },
            "page_count": {
              "aggs": {
                "pages": {
                  "sum": {
                    "field": "archive.total_pages"
                  }
                }
              },
              "reverse_nested": {}
            },
            "parent_doc_count": {
              "reverse_nested": {}
            },
            "relation_type": {
              "terms": {
                "field": "places.type",
                "order": {
                  "_key": "asc"
                },
                "size": 100
              }
            }
          },
          "terms": {
            "field": "places.id",
            "size": 10000
          }
        }
      },
      "nested": {
        "path": "places"
      }
    }
  },
  "query": {
    "bool": {
      "must": [
        {
          "bool": {
            "should": [
              {
                "match": {
                  "transcriptionstatus": "published"
                }
              },
              {
                "match": {
                  "transcriptionstatus": "accession"
                }
              },
              {
                "match": {
                  "transcriptionstatus": "readytocontribute"
                }
              }
            ]
          }
        },
        {
          "bool": {
            "should": [
              {
                "match": {
                  "publishstatus": "published"
                }
              }
            ]
          }
        },
        {
          "bool": {
            "should": [
              {
                "multi_match": {
                  "fields": [
                    "text^2",
                    "search_other",
                    "metadata.value",
                    "title",
                    "contents",
                    "archive.archive",
                    "archive.archive_id",
                    "archive.archive_id_row",
                    "places.name",
                    "places.landskap",
                    "places.county",
                    "places.harad",
                    "persons.name",
                    "id",
                    "headwords",
                    "title"
                  ],
                  "minimum_should_match": "100%",
                  "query": "rompedrag",
                  "type": "best_fields"
                }
              },
              {
                "nested": {
                  "inner_hits": {
                    "highlight": {
                      "fields": {
                        "text": {
                          "number_of_fragments": 0
                        }
                      },
                      "post_tags": [
                        "</span>"
                      ],
                      "pre_tags": [
                        "<span class=\"highlight\">"
                      ]
                    }
                  },
                  "path": "media",
                  "query": {
                    "multi_match": {
                      "fields": [
                        "media.text"
                      ],
                      "minimum_should_match": "100%",
                      "query": "rompedrag",
                      "type": "best_fields"
                    }
                  }
                }
              },
              {
                "nested": {
                  "inner_hits": {
                    "_source": false,
                    "highlight": {
                      "fields": {
                        "description.text": {
                          "number_of_fragments": 0
                        }
                      },
                      "post_tags": [
                        "</span>"
                      ],
                      "pre_tags": [
                        "<span class=\"highlight\">"
                      ]
                    },
                    "name": "media_with_description"
                  },
                  "path": "media",
                  "query": {
                    "nested": {
                      "inner_hits": {
                        "highlight": {
                          "fields": {
                            "text": {
                              "number_of_fragments": 0
                            }
                          },
                          "post_tags": [
                            "</span>"
                          ],
                          "pre_tags": [
                            "<span class=\"highlight\">"
                          ]
                        }
                      },
                      "path": "media.description",
                      "query": {
                        "match": {
                          "media.description.text": {
                            "operator": "and",
                            "query": "rompedrag"
                          }
                        }
                      }
                    }
                  }
                }
              },
              {
                "nested": {
                  "inner_hits": {
                    "_source": false,
                    "highlight": {
                      "fields": {
                        "utterances.utterances.text": {
                          "number_of_fragments": 0
                        }
                      },
                      "post_tags": [
                        "</span>"
                      ],
                      "pre_tags": [
                        "<span class=\"highlight\">"
                      ]
                    },
                    "name": "media_with_utterances"
                  },
                  "path": "media",
                  "query": {
                    "nested": {
                      "inner_hits": {
                        "highlight": {
                          "fields": {
                            "text": {
                              "number_of_fragments": 0
                            }
                          },
                          "post_tags": [
                            "</span>"
                          ],
                          "pre_tags": [
                            "<span class=\"highlight\">"
                          ]
                        }
                      },
                      "path": "media.utterances.utterances",
                      "query": {
                        "match": {
                          "media.utterances.utterances.text": {
                            "operator": "and",
                            "query": "rompedrag"
                          }
                        }
                      }
                    }
                  }
                }
              }
            ]
          }
        },
        {
          "bool": {
            "should": [
              {
                "match": {
                  "materialtype": "arkiv"
                }
              }
            ]
          }
        },
        {
          "nested": {
            "path": "media",
            "query": {
              "exists": {
                "field": "media.source"
              }
            }
          }
        },
        {
          "bool": {
            "should": [
              {
                "match": {
                  "taxonomy.type": "tradark"
                }
              }
            ]
          }
        }
      ]
    }
  },
  "size": 0
}