# Reindex with pipeline
PUT _ingest/pipeline/rewrite-media-description
{
  "description": "Force re-analysis of media.description.text",
  "processors": [
    {
      "script": {
        "source": """
          if (ctx.media != null) {
            for (m in ctx.media) {
              if (m.containsKey('description')) {
                def rewritten = [];
                for (d in m.description) {
                  if (d.containsKey('text')) {
                    d.text = d.text;  // No-op to trigger reindex
                  }
                  rewritten.add(d);
                }
                m.description = rewritten;
              }
            }
          }
        """
      }
    }
  ]
}

POST _reindex
{
  "source": {
    "index": "isof-publik_20250507"
  },
  "dest": {
    "index": "isof-publik_20250507-double-nested-text",
    "pipeline": "rewrite-media-description"
  }
}

GET isof-publik_20250507-double-nested-text/_termvectors/bd00614:b_231626_a
{
  "fields": ["media.description.text"],
  "offsets": true,
  "positions": true
}

GET isof-publik_20250507-double-nested-text/_mapping/field/media.description.text

POST isof-publik_20250507-double-nested-text/_doc/bd00615_52211_a
{
  "media": [
    {
      "description": [
        {
          "text": "Nävgröt och fläsk"
        }
      ]
    }
  ]
}

GET isof-publik_20250507-double-nested-text/_termvectors/bd00615_52211_a
{
  "fields": ["media.description.text"],
  "offsets": true,
  "positions": true
}

# TEST New small test index
PUT isof-highlight-test
{
  "mappings": {
    "properties": {
      "media": {
        "type": "nested",
        "properties": {
          "description": {
            "type": "nested",
            "properties": {
              "text": {
                "type": "text",
                "analyzer": "swedish",
                "term_vector": "with_positions_offsets"
              }
            }
          }
        }
      }
    }
  }
}

PUT isof-highlight-test/_doc/1
{
  "media": [
    {
      "description": [
        {
          "text": "Nävgröt och fläsk"
        }
      ]
    }
  ]
}

GET isof-highlight-test/_termvectors/1
{
  "fields": ["media.description.text"],
  "offsets": true,
  "positions": true
}

# Test highlighting of nested fields
PUT test-highlight-nested
{
  "mappings": {
    "properties": {
      "media": {
        "type": "nested",
        "properties": {
          "description": {
            "type": "nested",
            "properties": {
              "text": {
                "type": "text",
                "analyzer": "swedish",
                "term_vector": "with_positions_offsets"
              }
            }
          }
        }
      }
    }
  }
}

PUT test-highlight-nested/_doc/1
{
  "media": [
    {
      "description": [
        {
          "text": "Korv och rompedrag"
        },
        {
          "text": "Nävgröt och fläsk"
        }
      ]
    }
  ]
}

GET test-highlight-nested/_search
{
  "query": {
    "nested": {
      "path": "media",
      "query": {
        "nested": {
          "path": "media.description",
          "query": {
            "match": {
              "media.description.text": "rompedrag"
            }
          },
          "inner_hits": {
            "highlight": {
              "type": "plain",
              "fields": {
                "text": {
                  "number_of_fragments": 0
                }
              },
              "pre_tags": ["<mark>"],
              "post_tags": ["</mark>"]
            }
          }
        }
      }
    }
  }
}

GET test-highlight-nested/_search
{
  "query": {
    "nested": {
      "path": "media",
      "query": {
        "nested": {
          "path": "media.description",
          "query": {
            "match": {
              "media.description.text": "rompedrag"
            }
          },
          "inner_hits": {
            "highlight": {
              "type": "plain",
              "fields": {
                "media.description.text": {
                  "number_of_fragments": 0
                }
              },
              "pre_tags": ["<mark>"],
              "post_tags": ["</mark>"]
            }
          }
        }
      }
    }
  }
}

# Try this minimal test query to isolate the problem:
GET isof-publik_20250509-metadata/_search
{
  "query": {
    "nested": {
      "path": "media",
      "query": {
        "nested": {
          "path": "media.utterances.utterances",
          "query": {
            "match_phrase": {
              "media.utterances.utterances.text": "vråhållet"
            }
          }
        }
      }
    }
  },
  "_source": ["id", "media.utterances.utterances.text"]
}

# Minimal test query 2 to isolate the problem:
# Test highlighting of nested fields
# Works 2025-05-09 with highligh
GET isof-publik_20250509-metadata/_search
{
  "query": {
    "nested": {
      "path": "media.utterances.utterances",
      "query": {
        "match_phrase": {
          "media.utterances.utterances.text": "vråhållet"
        }
      },
      "inner_hits": {
        "name": "matched_utterance",
        "highlight": {
          "fields": {
            "media.utterances.utterances.text": {
              "number_of_fragments": 0
            }
          },
          "pre_tags": ["<em>"],
          "post_tags": ["</em>"]
        }
      }
    }
  },
  "_source": ["id"]
}
